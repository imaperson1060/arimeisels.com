<!DOCTYPE html>
<html>
    <head>
        <title>YouTube Ad-Free</title>
        <meta name="description" content="Watch (or download) YouTube videos without any ads, for free! (Seriously, no hidden fees or conditions or anything.)">
        <meta name="author" content="Ari Meisels">
        <meta property="og:image" content="/favicon.png">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="/favicon.ico">
        <link rel="stylesheet" href="/style.css">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
        <script src="/socket.io.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" onload="$.getScript('/downAlert.js')"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="bootstrap-dialog.js"></script>

        <script src="/script.js"></script>
        <script src="/nav.js"></script>
		<script src="jszip.js"></script>
		<script src="save.js"></script>
    </head>
    <body>        
        <div class="container">
            <h1>Watch YouTube Ad-Free</h1>

            <div id="urls" class="mb-3">
                <div class="mb-3">
                    <ul id="videos" class="list-group">
                    </ul>
                </div>
                <div class="d-grid gap-2">
                    <button id="addButton" class="btn btn-primary" type="button" onclick="addVideo()"><i class="bi bi-plus-circle"></i> Add Video</button>
                </div>
            </div>

            <div id="cookieInput" class="mb-3" style="display:none;">
                <label for="cookie" class="form-label">Account Cookie <span style="color: #ff2825">*</span></label>
                <input id="cookie" class="form-control" placeholder="Account Cookie...">
            </div>

            <button id="submit" class="btn btn-primary" value="Submit" disabled>
                <div id="loadingCircle" class="" role="status"></div>
                Video
            </button>
            <button id="submitAudio" class="btn btn-secondary" value="Submit" disabled>
                <div id="loadingCircleAudio" class="" role="status"></div>
                Audio - Coming Soon!
            </button>

			<br>
			<br>
			
			<div id="progressContainer" class="progress" style="display:none;">
				<div id="progressbar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">0%</div>
			</div>
            
            <br>
            <br>

            <div id="warnings" role="alert">
            </div>
        </div>
        
        <script>
            function getId(url) {
                var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
                var match = url.match(regExp);
                return (match && match[7].length == 11) ? match[7] : false;
            }

            var videos = [];
            var upto = 0;

            function HTMLWarn(text) { return `<div class="alert alert-warning alert-dismissible fade show" role="alert"> <strong>Warning!</strong> ${text} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`; }

            function addVideo() {
                var template = (id, title, author) => `<div class="btn-group" role="group" video-id="${id}">
                    <button type="button" class="list-group-item list-group-item-info list-group-item-action" onclick="showInfo('${id}')"><b><i>${title}</i></b> by <b>${author}</b></button>
                    <button type="button" class="btn btn-danger" onclick="removeVideo('${id}')"><i class="bi bi-trash"></i></button>
                </div>`;

                $.dialog.prompt("Add Video", "Paste YouTube URL", { type: "text", label: "URL..." }, async (url) => {
                    if (!getId(url) || !await getVideoInfo(getId(url))) return $.dialog.alert("Invalid ID", "The requested video does not exist, or is private. If you are sure that it does, please contact me so I can fix this bug.");

                    var id = getId(url);
                    var info = await getVideoInfo(id);
                    $("#videos").append(template(id, info.title, info.author_name));
                });
            }

            function removeVideo(id) {
                $(`button[video-id=${id}]`).parent().remove();
            }

            async function showInfo(id) {
                var info = await getVideoInfo(id);

                $.dialog.alert(`<a href="https://youtu.be/${id}" target="_blank"><b><i>${info.title}</i></b></a> by <a href="${info.author_url}" target="_blank"><b>${info.author_name}</b></a>`, `<a href="https://youtu.be/${id}" target="_blank"><img src="${info.thumbnail_url}"></a>`);
            }

            function changeProgress(percent) {
                $("#progressContainer").show();

				$("#progressbar").css("width", `${percent}%`);
				$("#progressbar").attr("aria-valuenow", percent);
				if (percent < 100) {
					$("#progressbar").html(`${percent}% (${upto + 1} out of ${videos.length})`);
				} else {
					$("#progressbar").html("Done! Zipping files...");
					$("#progressbar").removeClass("bg-primary");
					$("#progressbar").addClass("bg-info");
				}
            }

            async function getVideo(video) {
                let response = await fetch("https://bot.arimeisels.com/ytdl", { method: "POST", body: video });

                const reader = response.body.getReader();

                var contentLength = response.headers.get("Content-Length");

                let receivedLength = 0;
                let chunks = [];
                while (true) {
                    const {done, value} = await reader.read();

                    if (done) break;

                    chunks.push(value);
                    receivedLength += value.length;

                    changeProgress(Math.ceil((((100 / videos.length) * upto) + Math.ceil((((receivedLength / contentLength) * 100) / videos.length) * 100) / 100) * 100) / 100);
                }

                let blob = new Blob(chunks);

                return blob;
            }

            /*async function getAudio(video) {
                let response = await fetch("https://bot.arimeisels.com/ytdl?audio=true", { method: "POST", body: video });

                const reader = response.body.getReader();

                var contentLength = response.headers.get("Content-Length");

                let receivedLength = 0;
                let chunks = [];
                while (true) {
                    const {done, value} = await reader.read();

                    if (done) break;

                    chunks.push(value);
                    receivedLength += value.length;

                    changeProgress(Math.ceil((((100 / videos.length) * upto) + Math.ceil((((receivedLength / contentLength) * 100) / videos.length) * 100) / 100) * 100) / 100);
                }
            }*/

            async function downloadVideos(audio = false) {
				var zip = new JSZip();

                $("#submit").attr("disabled", true);
                $("#addButton").attr("disabled", true);

                for await (const x of videos) {
                    if (audio) await zip.file(`${(await getVideoInfo(x)).title}.mp3`, await getAudio(x), { binary: true });
                    else await zip.file(`${(await getVideoInfo(x)).title}.mp4`, await getVideo(x), { binary: true });
                    upto++;
                }
                
                await zip.generateAsync({ type: "blob" })
                .then((content) => {
                    saveAs(content, `arimeisels.com_batch_${Date.now()}.zip`);
						$("#progressbar").html("Your download should begin... now!");
						$("#progressbar").removeClass("bg-info");
						$("#progressbar").addClass("bg-success");
						$("#progressbar").removeClass("progress-bar-animated");
						$("#progressbar").removeClass("progress-bar-striped");
                });

                $("#submit").attr("disabled", false);
                $("#addButton").attr("disabled", false);

                $("#loadingCircle").removeClass("spinner-border spinner-border-sm text-light");
                $("#loadingCircleAudio").removeClass("spinner-border spinner-border-sm text-light");
            }

            $("#submit").on("click", async () => {
                $("#progressbar").removeClass("bg-success");
                $("#progressbar").html("");
                changeProgress(0);
                videos = [];
                upto = 0;

                $("#loadingCircle").addClass("spinner-border spinner-border-sm text-light");

                $("#warnings").html("");

                $.each($("#videos").children(), (i, x) => videos.push($(x).attr("video-id")));

                if (videos.length) downloadVideos();
            });

            /*$("#submitAudio").on("click", async () => {
                $("#progressbar").removeClass("bg-success");
                $("#progressbar").html("");
                changeProgress(0);
                videos = [];
                upto = 0;

                $("#loadingCircleAudio").addClass("spinner-border spinner-border-sm text-light");

                $("#warnings").html("");

                $("#urls").val().split("\n").every(x => {
                    const id = getId(x);
                    if (!id) {
                        $("#warnings").html(HTMLWarn(`The video "<a href='${x}'>${x}</a>" does not exist or is private. Unfortunately, cookies are not supported. The download process has been cancelled.`));   
                        videos = [];
                        return false;
                    } else {
                        videos.push(id);
                        return true;
                    }
                });

                if (videos.length) downloadVideos(true);
            });*/

            $("#videos").on("DOMSubtreeModified", async () => {
                var videos = [];
                $.each($("#videos").children(), (i, x) => videos.push($(x).attr("video-id")));
                
                if (videos.length != 0) {
                    $("#warnings").html("");
                    $("#submit").attr("disabled", false);
                    //$("#submitAudio").attr("disabled", false);
                } else {
                    $("#submit").attr("disabled", true);
                    $("#submitAudio").attr("disabled", true);
                }
            });

            async function getVideoInfo(id) {
                try {
                    const video = await fetch(`https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=${id}`);

                    if (video.ok) {
                        return await video.json();
                    } else {
                        return false;
                    }
                } catch (e) { return false; }
            }
        </script>
    </body>
</html>