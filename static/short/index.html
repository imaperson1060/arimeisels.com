<!DOCTYPE html>
<html>
    <head>
        <title>URL Shortener</title>
        <meta name="description" content="Shorten URLs quickly and easily.">
        <meta name="author" content="Ari Meisels">
        <meta property="og:image" content="/favicon.png">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="/favicon.ico">
        <link rel="stylesheet" href="/style.css">        
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
        <script src="/socket.io.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" onload="$.getScript('/downAlert.js')"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>

        <script src="/script.js"></script>
        <script src="/nav.js"></script>
    </head>
    <body>
        <div class="container">
            <h1>URL Shortener</h1>
            
            <div class="mb-3">
                <label for="httpLabel" class="form-label">URL <span style="color: #ff2825">*</span></label>
                <div class="input-group mb-3">
                    <span class="input-group-text" id="protocol">http://</span>
                    <input id="url" class="form-control" maxlength="2000" placeholder="URL to be shortened...">
                </div>
            </div>
            
            <label for="domain-gray" class="form-label">Domain</label>
            <div class="input-group mb-3">
                <span class="input-group-text" id="domain-gray">ariurls.</span>
                <select id="domain" class="input-group form-select" aria-label="form-select-sm">
                    <option id="tk" value="tk" selected>tk</option>
                    <option id="gq" value="gq">gq</option>
                    <option id="cf" value="cf">cf</option>
                    <option id="ga" value="ga">ga</option>
                    <option id="ml" value="ml">ml</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="customurl" class="form-label">Custom URL (optional)</label>
                <input id="customurl" class="form-control" maxlength="32" placeholder="Custom URL...">
            </div>
            
            <label for="expiration" class="form-label">Expiration</label>
            <div class="mb-3">
                <select id="expiration" class="form-select">
                    <option id="12h" value="12h" selected>12 Hours</option>
                    <option id="1d" value="1d">1 Day (24 hours)</option>
                    <option id="1w" value="1w">1 Week (7 days)</option>
                    <option id="1m" value="1m">1 Month (4 weeks)</option>
                    <option id="6m" value="6m">6 Months (24 weeks)</option>
                    <option id="1y" value="1y">1 Year (365 days)</option>
                    <option id="∞" value="∞">∞</option>
                    <option id="Custom" value="c">Custom...</option>
                </select>
            </div>
            
            <div id="customExpirationdiv" class="mb-3"></div>
            
            <button id="submit" class="btn btn-primary" value="Submit">Submit</button>
            
            <br>
            <br>
            
            <div id="warnings" role="alert">
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong>Warning!</strong>
                    You will not be able to edit or delete your URL after submitting because you are not logged in.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
        
        <script>
            (async function () {
                if (localStorage.getItem("auth")) {
                    $("#warnings").html("");
                }
            })();            

            function HTMLError(text) { return `<div class="alert alert-danger alert-dismissible fade show" role="alert"> <strong>Error!</strong> ${text} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`; }
            
            async function shorten(expires) {
                var creator = undefined;

                if (localStorage.getItem("auth")) {
                    creator = JSON.parse(localStorage.getItem("auth")).username;
                }

                socket.emit("short", "new", { url: encodeURIComponent($("#url").val()), customid: !!$("#customurl").val() ? $("#customurl").val() : undefined, domain: $("#domain").val(), expires, creator });
            }
            
            $("#url").on("input", async function() {
                if ($("#url").val().substr(0, 8) == "https://") {
                    $("#url").val($("#url").val().replace("https://", ""));
                    $("#protocol").html("https://");
                }
                
                if ($("#url").val().substr(0, 7) == "http://") {
                    $("#url").val($("#url").val().replace("http://", ""));
                    $("#protocol").html("http://");
                }
                
                function validURL(str) {
                    var pattern = new RegExp("^(https?:\\/\\/)?"+ // protocol
                                             "((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|"+ // domain name
                                             "((\\d{1,3}\\.){3}\\d{1,3}))" + // OR ip (v4) address
                                             "(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*" + // port and path
                                             "(\\?[;&a-z\\d%_.~+=-]*)?" + // query string
                                             "(\\#[-a-z\\d_]*)?$","i"); // fragment locator
                    return !!pattern.test(str);
                }
                
                if (validURL($("#url").val())) {
                    const protocol = await fetch("https://bot.arimeisels.com/url", { method: "POST", body: $("#url").val() });
                    res = await protocol.json();
                    if (res.https) {
                        $("#url").val($("#url").val().replace("https://", ""));
                        $("#protocol").html("https://");
                    } else {
                        $("#url").val($("#url").val().replace("http://", ""));
                        $("#protocol").html("http://");
                    }
                }
            });
            
            $("#customurl").on("input", function() {
                $("#customurl").val($("#customurl").val().replace(" ", "-"));
                $("#customurl").val($("#customurl").val().replace(/[^a-z0-9_-]/gi, ""));
                
                const urls = ["tk", "gq", "cf", "ga", "ml"];
                var prefix = "/";
                
                if (!$("#customurl").val()) {
                    prefix = "";
                }
                
                for (var i = 0; i < urls.length; i++) {
                    $(`#${urls[i]}`).html(`${urls[i]}${prefix}${$("#customurl").val()}`);
                }
            });
            
            $("#expiration").on("change", function () {
                if ($("#expiration").val() == "c") {
                    $("#customExpirationdiv").html(`<label for="customExpiration" class="form-label">Custom Expiration Time</label><input id="customExpiration" class="form-control" maxlength="10" placeholder="Epoch Timestamp...">`);
                } else {
                    $("#customExpirationdiv").html("");
                }
            });
            
            $("#submit").on("click", function() {
                if ($("#url").val()) {
                    if (!$("#customExpiration").length) {
                        var expires;
                        
                        switch (expiration.value) {
                            case "∞":
                                expires = "2147483647";
                                break;
                            case "12h":
                                expires = Math.round(new Date().getTime() / 1000) + 43200;
                                break;
                            case "1d":
                                expires = Math.round(new Date().getTime() / 1000) + 86400;
                                break;
                            case "1w":
                                expires = Math.round(new Date().getTime() / 1000) + 604800;
                                break;
                            case "1m":
                                expires = Math.round(new Date().getTime() / 1000) + 2419200;
                                break;
                            case "6m":
                                expires = Math.round(new Date().getTime() / 1000) + 14515200;
                                break;
                            case "1y":
                                expires = Math.round(new Date().getTime() / 1000) + 31536000;
                        }
                        
                        return shorten(expires);
                    }
                    
                    if (isNaN($("#customExpiration").val())) {
                        $("#warnings").html(HTMLError("This custom timestamp has to be a number."));
                    } else {
                        if (!$("#customExpiration").val() == "") {
                            if ($("#customExpiration").val() > Math.round(new Date().getTime() / 1000)) {
                                if (($("#customExpiration").val() - 600) > Math.round(new Date().getTime() / 1000)) {
                                    if ($("#customExpiration").val() > 2147483647) {
                                        warnings.innerHTML = HTMLError("This time exceeds the maximum epoch timestamp.");
                                    } else {
                                        shorten($("#customExpiration").val())
                                    }
                                } else {
                                    $("#warnings").html(HTMLError("This time will happen in less than 10 minutes."));
                                }
                            } else {
                                $("#warnings").html(HTMLError("This time already happened."));
                            }
                        } else {
                            $("#warnings").html(HTMLError("You need to enter a timestamp."));
                        }
                    }
                } else {
                    $("#warnings").html(HTMLError("You need to fill out the URL field."));
                }
            });
            
            socket.on("short-new", (data) => {
                if (data.success) {
                    $("#warnings").html(`<div class="alert alert-success alert-dismissible fade show" role="alert"> <strong>Success!</strong> Your URL: <a href="https://ariurls.${$("#domain").val()}/${data.message}" target="_blank">ariurls.${$("#domain").val()}/${data.message}/</a>. <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`);
                } else {
                    $("#warnings").html(HTMLError(`Our servers returned the following error: ${data.message}`));
                }
            });

            $(document).keypress(function(event) {
                if ((event.keyCode ? event.keyCode : event.which) == "13") {
                    $("#submit").click();
                }
            });
        </script>
    </body>
</html>