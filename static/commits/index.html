<!DOCTYPE html>
<html>
    <head>
        <title>Recent Commits</title>
        <meta name="description" content="The most recent commits to my site (within the last week - maximum of 100).">
        <meta name="author" content="Ari Meisels">
        <meta property="og:image" content="/favicon.png">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="/favicon.ico">
        <link rel="stylesheet" href="/style.css">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    </head>
    <body>
        <div id="navbar" class="mb-4"></div>
        
        <script src="/nav.js"></script>
        
        <div class="container">
            <h1>Recent Commits (<span id="recent">...</span>) - <a href="//github.com/meisels/arimeisels.com/" target="_blank">View Repository</a></h1>
            <p class="lead">From <span id="then">...</span> to <span id="now">...</span></p>

            <br>
            <br>

            <div id="commits">
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>

        <script>
            const socket = io();

            socket.emit("github", "commits");

            socket.on("github-commits", async (commits) => {
                commits = commits.commits;

                $("#recent").html(commits.length);

                $("#then").html(moment().subtract(7, "d").format("MM/DD/YYYY"));
                $("#now").html(moment().format("MM/DD/YYYY"));

                var cards = new Array(commits.length);

                for (var i = 0; i < commits.length; i++) {
                    (async (data, i) => {
                        var card = document.createElement("div");
                        card.setAttribute("class", "card mb-3");
                        card.setAttribute("style", "max-width: 540px;");

                        var grid = document.createElement("div");
                        grid.setAttribute("class", "row g-0");

                        var imageFrame = document.createElement("div");
                        imageFrame.setAttribute("class", "col-md-4");

                        var image = document.createElement("img");
                        image.setAttribute("src", data.author.avatar_url);
                        image.setAttribute("class", "card-img-top");
                        image.setAttribute("alt", data.commit.author.name);

                        imageFrame.appendChild(image);
                        grid.appendChild(imageFrame);

                        var commitInfo = document.createElement("div");
                        commitInfo.setAttribute("class", "col-md-8");

                        var body = document.createElement("div");
                        body.setAttribute("class", "card-body");

                        var title = document.createElement("h5");
                        title.setAttribute("class", "card-header");
                        title.setAttribute("title", data.commit.message);
                        title.setAttribute("style", "margin-bottom: 2.5% !important;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;");
                        var titleText = document.createElement("a");
                        titleText.setAttribute("href", data.html_url);
                        titleText.setAttribute("target", "_blank");
                        var titleTextNode = document.createTextNode(data.commit.message.split("\n")[0]);
                        titleText.appendChild(titleTextNode);
                        title.appendChild(titleText);

                        body.appendChild(title);


                        var author = document.createElement("div");
                        author.setAttribute("class", "btn-group");
                        author.setAttribute("style", "margin-bottom: 1px !important");
                        var authorIcon = document.createElement("label");
                        authorIcon.setAttribute("class", "input-group-text bi bi-person-circle");
                        author.appendChild(authorIcon);
                        var authorLink = document.createElement("a");
                        authorLink.setAttribute("href", data.author.html_url);
                        authorLink.setAttribute("class", "btn btn-primary");
                        authorLink.setAttribute("target", "_blank");
                        var authorText = document.createTextNode(data.commit.author.name);
                        authorLink.appendChild(authorText);
                        author.appendChild(authorLink);

                        var forceNewLine = document.createElement("br");

                        body.appendChild(author);
                        body.appendChild(forceNewLine);


                        var footer = document.createElement("div");
                        footer.setAttribute("class", "card-footer");
                        var footerText = document.createTextNode(moment(data.commit.author.date).format("dddd, MMMM Do YYYY, h:mm:ss a"));
                        footer.appendChild(footerText);


                        var changes = document.createElement("div");
                        changes.setAttribute("class", "btn-group");
                        changes.setAttribute("style", "margin-bottom: 1px !important");
                        var changesIcon = document.createElement("label");
                        changesIcon.setAttribute("class", "input-group-text");
                        changesSvg = document.createElement("img");
                        changesSvg.setAttribute("src", "https://upload.wikimedia.org/wikipedia/commons/1/1c/Octicons-diff.svg");
                        changesSvg.setAttribute("width", 14.5);
                        changesSvg.setAttribute("height", 16);
                        changesIcon.appendChild(changesSvg);
                        changes.appendChild(changesIcon);
                        var changesLink = document.createElement("button");
                        changesLink.setAttribute("class", "btn btn-warning");
                        changesLink.setAttribute("disabled", true);
                        var changesText = document.createTextNode(data.stats.total);
                        changesLink.appendChild(changesText);
                        changes.appendChild(changesLink);

                        var nbsp = document.createTextNode("\xa0");

                        body.appendChild(changes);
                        body.appendChild(nbsp);


                        var additions = document.createElement("div");
                        additions.setAttribute("class", "btn-group");
                        additions.setAttribute("style", "margin-bottom: 1px !important");
                        var additionsIcon = document.createElement("label");
                        additionsIcon.setAttribute("class", "input-group-text bi bi-plus");
                        additions.appendChild(additionsIcon);
                        var additionsLink = document.createElement("button");
                        additionsLink.setAttribute("class", "btn btn-success");
                        additionsLink.setAttribute("disabled", true);
                        var additionsText = document.createTextNode(data.stats.additions);
                        additionsLink.appendChild(additionsText);
                        additions.appendChild(additionsLink);

                        var nbsp = document.createTextNode("\xa0");

                        body.appendChild(additions);
                        body.appendChild(nbsp);


                        var deletions = document.createElement("div");
                        deletions.setAttribute("class", "btn-group");
                        deletions.setAttribute("style", "margin-bottom: 1px !important");
                        var deletionsIcon = document.createElement("label");
                        deletionsIcon.setAttribute("class", "input-group-text bi bi-dash");
                        deletions.appendChild(deletionsIcon);
                        var deletionsLink = document.createElement("button");
                        deletionsLink.setAttribute("class", "btn btn-danger");
                        deletionsLink.setAttribute("disabled", true);
                        var deletionsText = document.createTextNode(data.stats.deletions);
                        deletionsLink.appendChild(deletionsText);
                        deletions.appendChild(deletionsLink);

                        body.appendChild(deletions);


                        commitInfo.appendChild(body);
                        grid.appendChild(commitInfo);
                        card.appendChild(grid);
                        card.appendChild(footer);
                        cards[i] = card;
                    })(commits[i], i);
                }

                function waitFor(condition, callback) {
                    if(!condition()) {
                        window.setTimeout(waitFor.bind(null, condition, callback), 100);
                    } else {
                        callback();
                    }
                }

                waitFor(() => commits.length - cards.filter(function(x, i){ return true }).length == 0, () => {
                    cards.forEach(card => {
                        document.getElementById("commits").appendChild(card);
                    });
                });
            });
        </script>
    </body>
</html>